name: CI Environment Cleanup (Aggressive-Safe)

on:
  workflow_run:
    workflows:
      - SSH Generate & Save .config
      - Build OpenWrt
      - Build LEDE
      - Build ImmortalWrt
    types:
      - completed

permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
      - name: BEFORE CLEANUP â€” Disk Usage
        if: ${{ always() }}
        run: |
          echo "=== BEFORE CLEANUP ==="
          df -h
          du -h --max-depth=1 / \
            --exclude=/proc \
            --exclude=/sys \
            --exclude=/dev \
            2>/dev/null | sort -hr | head -n 20

      # -----------------------------
      # ç³»ç»Ÿé¢„è£…ç»„ä»¶ï¼ˆå®‰å…¨ï¼‰
      # -----------------------------
      - name: Remove Preinstalled SDKs & Toolchains
        if: ${{ always() }}
        run: |
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /usr/local/lib/android || true
          # â— ä¿ç•™ /opt/hostedtoolcacheï¼ˆOpenWrt host tools å¿…é¡»ç”¨ï¼‰
          # sudo rm -rf /opt/hostedtoolcache || true

      # -----------------------------
      # è¯­è¨€çŽ¯å¢ƒç¼“å­˜ï¼ˆå®‰å…¨ï¼‰
      # -----------------------------
      - name: Clean Node / npm / yarn
        if: ${{ always() }}
        run: |
          sudo rm -rf ~/.npm
          sudo rm -rf ~/.cache/yarn
          sudo rm -rf ~/.nvm

      - name: Clean Python / pip
        if: ${{ always() }}
        run: |
          sudo rm -rf ~/.cache/pip
          # â— ä¿ç•™ python dist-packagesï¼ˆOpenWrt host tools å¿…é¡»ç”¨ï¼‰
          # sudo rm -rf /usr/local/lib/python*/dist-packages

      - name: Clean Rust / Cargo
        if: ${{ always() }}
        run: |
          sudo rm -rf ~/.cargo
          sudo rm -rf ~/.rustup

      - name: Clean Go Modules
        if: ${{ always() }}
        run: |
          sudo rm -rf ~/go/pkg/mod
          sudo rm -rf ~/go/bin

      # -----------------------------
      # Homebrewï¼ˆä¸èƒ½åˆ ï¼‰
      # -----------------------------
      # â— Homebrew å†…å« cmake/ninja/pythonï¼ŒOpenWrt å¿…é¡»ç”¨
      # - name: Clean Homebrew
      #   run: |
      #     sudo rm -rf /home/linuxbrew/.linuxbrew

      # -----------------------------
      # Docker
      # -----------------------------
      - name: Docker prune
        if: ${{ always() }}
        run: sudo docker system prune -af || true

      - name: Deep clean Docker overlay2
        if: ${{ always() }}
        run: sudo rm -rf /var/lib/docker/overlay2/*

      # -----------------------------
      # APT / æ—¥å¿— / ä¸´æ—¶æ–‡ä»¶
      # -----------------------------
      - name: Clean APT & Logs
        if: ${{ always() }}
        run: |
          sudo apt-get clean
          sudo apt-get autoremove -y
          sudo apt-get autoclean -y
          sudo rm -rf /var/lib/apt/lists/*
          sudo rm -rf /var/log/*
          sudo rm -rf /tmp/* /var/tmp/*

      - name: Clean systemd journal
        if: ${{ always() }}
        run: |
          sudo journalctl --rotate
          sudo journalctl --vacuum-time=1s

      # -----------------------------
      # /mntï¼ˆä¿ç•™ swapfileï¼‰
      # -----------------------------
      - name: Clean /mnt except swapfile
        if: ${{ always() }}
        run: |
          sudo find /mnt -mindepth 1 -maxdepth 1 ! -name swapfile -exec rm -rf {} +
          sudo mkdir -p /mnt
          sudo chown $USER:$USER /mnt

      # -----------------------------
      # æ¸…ç†åŽç£ç›˜ä½¿ç”¨æƒ…å†µ
      # -----------------------------
      - name: AFTER CLEANUP â€” Disk Usage
        if: ${{ always() }}
        run: |
          echo "=== AFTER CLEANUP ==="
          df -h
          du -h --max-depth=1 / \
            --exclude=/proc \
            --exclude=/sys \
            --exclude=/dev \
            2>/dev/null | sort -hr | head -n 20

      - name: Cleanup Done
        if: ${{ always() }}
        run: echo "ðŸ”¥ Aggressive-Safe runner cleanup completed"
