name: Daily CI Environment Cleanup

on:
  schedule:
    - cron: "0 6 * * *"   
  workflow_dispatch:     

permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: 显示清理前磁盘使用情况
        run: |
          echo "=== Disk usage BEFORE cleanup ==="
          df -h
          du -h --max-depth=1 / | sort -hr | head -n 20 || true

      ##################################################
      # 核心：释放 GitHub Runner 自带的大块垃圾
      ##################################################
      - name: 清理系统组件 & 工具缓存
        run: |
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /opt/hostedtoolcache || true

      - name: 清理 Docker
        run: |
          sudo docker image prune -af || true
          sudo docker container prune -f || true
          sudo docker volume prune -f || true
          sudo docker system prune -af || true

      - name: 清理 APT / 日志 / 临时文件
        run: |
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          sudo rm -rf /var/log/*
          sudo rm -rf /tmp/* /var/tmp/*

      ##################################################
      # /mnt 是 GitHub Runner 最大磁盘
      ##################################################
      - name: 清理 /mnt 临时目录
        run: |
          sudo rm -rf /mnt/*
          sudo mkdir -p /mnt
          sudo chown $USER:$USER /mnt

      - name: 显示清理后磁盘使用情况
        run: |
          echo "=== Disk usage AFTER cleanup ==="
          df -h
          du -h --max-depth=1 / | sort -hr | head -n 20 || true

      - name: Cleanup Finished
        run: |
          echo "✅ GitHub Actions Runner cleanup completed successfully"
