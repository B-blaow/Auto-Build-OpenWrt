name: SSH Generate & Save .config

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Select source'
        required: true
        default: openwrt
        type: choice
        options:
          - openwrt
          - immortalwrt
          - lede

      save_to_repo:
        description: 'Save generated .config back to repository'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'


jobs:
  ssh-config:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    env:
      WORKDIR: /mnt/workdir

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
          bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gcc-multilib g++-multilib gettext \
          genisoimage git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev \
          libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev \
          libreadline-dev libssl-dev libtool llvm lrzsz libnsl-dev ninja-build p7zip p7zip-full patch pkgconf \
          python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion \
          swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev
        sudo apt install -y \
          build-essential clang flex bison g++ gawk gcc-multilib \
          gettext git libncurses-dev libssl-dev python3 rsync unzip zlib1g-dev \
          tmate ccache

    - name: Prepare workspace
      run: |
        sudo mkdir -p /mnt
        sudo chown $USER:$USER /mnt


    - name: Clone source
      run: |
        mkdir -p $WORKDIR
        cd $WORKDIR

        case "${{ inputs.target }}" in
          openwrt)
            git clone https://github.com/openwrt/openwrt.git .
            ;;
          immortalwrt)
            git clone https://github.com/immortalwrt/immortalwrt.git .
            ;;
          lede)
            git clone https://github.com/coolsnowwolf/lede.git .
            ;;
        esac

        ./scripts/feeds update -a
        ./scripts/feeds install -a

        

    - name: üîê SSH (tmate)
      run: |
        cd $WORKDIR

        tmate new-session -d
        tmate wait tmate-ready

        SOCK="/tmp/tmate.sock"

        tmate -S "$SOCK" new-session -d
        tmate -S "$SOCK" wait tmate-ready

        SSH_CMD=$(tmate -S "$SOCK" display -p '#{tmate_ssh}')
        WEB_CMD=$(tmate -S "$SOCK" display -p '#{tmate_web}')

        echo "==============================================="
        SSH_CMD=$(tmate -S "$SOCK" display -p '#{tmate_ssh}')
        echo
        echo " SSH : $SSH_CMD"
        echo " WEB : $WEB_CMD"
        echo
        echo "==============================================="


    - name: Save .config back to repo
      run: |
        TARGET="${{ inputs.target }}"
        DEST="$GITHUB_WORKSPACE/configs/$TARGET"

        mkdir -p "$DEST"
        cp "$WORKDIR/.config" "$DEST/.config"

        echo "Saved .config to $DEST/.config"

    - name: Commit & push .config
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"

        git add configs/${{ inputs.target }}/.config

        if git diff --cached --quiet; then
          echo "No config changes to commit"
        else
          git commit -m "configs(${{
            inputs.target
          }}): update .config via SSH"
          git push
        fi

    - name: Upload .config artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.target }}-config
        path: $GITHUB_WORKSPACE/configs/${{ inputs.target }}/.config
